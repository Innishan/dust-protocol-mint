<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dust Protocol Mint</title>

    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b0b10; color:#fff; margin:0; }
      .wrap { max-width: 760px; margin: 0 auto; padding: 28px; }
      .card { background:#141420; border:1px solid #24243a; border-radius:16px; padding:18px; margin-bottom:14px; }
      button { padding:12px 14px; border-radius:12px; border:0; cursor:pointer; font-weight:800; }
      button.primary { background:#fff; color:#000; }
      button.secondary { background:#2b2b45; color:#fff; }
      button:disabled { opacity:0.55; cursor:not-allowed; }
      input { padding:12px; border-radius:12px; border:1px solid #2b2b45; background:#0e0e17; color:#fff; width:110px; }
      .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:13px; word-break: break-all; }
      .muted { color:#b7b7d6; font-size:14px; }
      .ok { color:#6dff9b; }
      .err { color:#ff6d6d; }
    </style>

    <!-- Ethers.js v6 -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.4/dist/ethers.umd.min.js"></script>
  </head>

  <body>
    <div class="wrap">
      <h1>Dust Protocol — Mint</h1>
      <p class="muted">
        Mint price: <b>33 MON</b> per NFT • Network: <b>Monad</b> (Chain ID 143)
      </p>

      <div class="card">
        <div class="row">
          <button id="connectBtn" class="primary">Connect MetaMask</button>
          <button id="switchBtn" class="secondary" disabled>Switch to Monad</button>
        </div>

        <p class="muted" style="margin-top:12px;">Wallet</p>
        <div id="wallet" class="mono">Not connected</div>

        <p class="muted" style="margin-top:12px;">Network</p>
        <div id="network" class="mono">Unknown</div>

        <p class="muted" style="margin-top:12px;">Contract</p>
        <div class="mono">0x053c782Bbf191c2B6e792bF829cFF039D55381fC</div>
        
        <p class="muted" style="margin-top:12px;">Minted</p>
        <div id="supply" class="mono">Loading...</div>
      </div>

      <div class="card">
        <div class="row">
          <div>
            <div class="muted">Quantity</div>
            <input id="qty" type="number" min="1" max="20" value="1" />
          </div>

          <div>
            <div class="muted">Total</div>
            <div id="total" style="font-size:20px; font-weight:900;">33 MON</div>
          </div>

          <div style="flex:1;"></div>
          <button id="mintBtn" class="primary" disabled>Mint</button>
        </div>

        <p class="muted" style="margin-top:12px;">
          Mint window: 7 days. Unminted supply burns after the window (contract logic).
        </p>

        <div id="status" class="mono" style="margin-top:10px;"></div>
      </div>
    </div>

    <script>
      // ===== CONFIG =====
      const CONTRACT = "0x053c782Bbf191c2B6e792bF829cFF039D55381fC";

      const CHAIN_ID_DEC = 143;
      const CHAIN_ID_HEX = "0x8f"; // 143
      const RPC_URL = "https://rpc.monad.xyz";

      const NATIVE = { name: "MON", symbol: "MON", decimals: 18 };

      // ABI: mint + read totalSupply
      const ABI = [
        "function mint(uint256 qty) external payable",
        "function totalSupply() view returns (uint256)"
      ];

      const PRICE_PER = ethers.parseEther("33"); // 33 MON

      // ===== UI =====
      const connectBtn = document.getElementById("connectBtn");
      const switchBtn = document.getElementById("switchBtn");
      const mintBtn = document.getElementById("mintBtn");
      const qtyEl = document.getElementById("qty");
      const totalEl = document.getElementById("total");
      const walletEl = document.getElementById("wallet");
      const networkEl = document.getElementById("network");
      const statusEl = document.getElementById("status");
      const supplyEl = document.getElementById("supply");
      const MAX_SUPPLY = 3333;


      let provider, signer, contract;

      function setStatus(msg, cls = "") {
        statusEl.className = "mono " + (cls || "");
        statusEl.textContent = msg;
      }

      function clampQty() {
        let q = Number(qtyEl.value || 1);
        if (Number.isNaN(q)) q = 1;
        q = Math.max(1, Math.min(20, q));
        qtyEl.value = q;
        return q;
      }

      function updateTotal() {
        const q = clampQty();
        const total = BigInt(q) * PRICE_PER;
        totalEl.textContent = `${ethers.formatEther(total)} MON`;
      }

      async function refreshSupply() {
        try {
          // Read-only provider (no wallet needed)
          const readProvider = new ethers.JsonRpcProvider(RPC_URL);
          const readContract = new ethers.Contract(CONTRACT, ["function totalSupply() view returns (uint256)"], readProvider);

          const minted = await readContract.totalSupply();
          supplyEl.textContent = `Minted: ${minted.toString()} / ${MAX_SUPPLY}`;
        } catch (e) {
          supplyEl.textContent = "Minted: (unable to fetch right now)";
        }
      }

      async function refreshNetwork() {
        if (!provider) return;
        const net = await provider.getNetwork();
        networkEl.textContent = `Chain ID: ${net.chainId}`;

        const onMonad = Number(net.chainId) === CHAIN_ID_DEC;
        switchBtn.disabled = onMonad;
        mintBtn.disabled = !(onMonad && signer);
      }

      async function connect() {
        if (!window.ethereum) {
          setStatus("MetaMask not found. Install MetaMask extension.", "err");
          return;
        }
        provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = await provider.getSigner();
        walletEl.textContent = await signer.getAddress();
        contract = new ethers.Contract(CONTRACT, ABI, signer);

        connectBtn.disabled = true;
        switchBtn.disabled = false;

        await refreshNetwork();
        setStatus("Connected.", "ok");
      }

      async function switchToMonad() {
        try {
          await window.ethereum.request({
            method: "wallet_switchEthereumChain",
            params: [{ chainId: CHAIN_ID_HEX }]
          });
        } catch (e) {
          if (e.code === 4902) {
            // add chain
            await window.ethereum.request({
              method: "wallet_addEthereumChain",
              params: [{
                chainId: CHAIN_ID_HEX,
                chainName: "Monad",
                rpcUrls: [RPC_URL],
                nativeCurrency: NATIVE
              }]
            });
          } else {
            setStatus(`Switch failed: ${e.message || e}`, "err");
            return;
          }
        }
        await refreshNetwork();
        setStatus("Switched to Monad.", "ok");
      }

      async function mint() {
        if (!contract) {
          setStatus("Connect wallet first.", "err");
          return;
        }

        const q = clampQty();
        const value = BigInt(q) * PRICE_PER;

        try {
          mintBtn.disabled = true;
          setStatus(`Minting ${q} NFT(s)... Confirm in MetaMask`);

          const tx = await contract.mint(q, { value });
          setStatus(`Tx sent: ${tx.hash}`);

          const receipt = await tx.wait();
          setStatus(`✅ Mint confirmed. Block ${receipt.blockNumber}. Tx: ${tx.hash}`, "ok");
        } catch (e) {
          setStatus(`Mint failed: ${e.shortMessage || e.message || e}`, "err");
        } finally {
          await refreshNetwork();
        }
      }

      // events
      qtyEl.addEventListener("input", updateTotal);
      connectBtn.addEventListener("click", connect);
      switchBtn.addEventListener("click", switchToMonad);
      mintBtn.addEventListener("click", mint);

      if (window.ethereum) {
        window.ethereum.on("chainChanged", () => window.location.reload());
        window.ethereum.on("accountsChanged", () => window.location.reload());
      }

      updateTotal();
      setStatus("Ready. Connect MetaMask to mint.");
      refreshSupply();
      setInterval(refreshSupply, 10000);
    </script>
  </body>
</html>

